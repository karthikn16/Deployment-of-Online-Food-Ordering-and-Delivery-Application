pipeline {
    agent any

    tools {
        jdk 'jdk17'
        nodejs 'node18'
    }

    environment {
        SONAR_SCANNER = tool 'SonarQube'
        SONAR_SERVER  = 'SonarQube'

        DOCKER_IMAGE  = 'karthikn16/zomato:latest'
        CONTAINER     = 'zomato'
    }

    stages {

        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Git Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/karthikn16/Deployment-of-Online-Food-Ordering-and-Delivery-Application.git'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONAR_SERVER}") {
                    sh """
                    ${SONAR_SCANNER}/bin/sonar-scanner \
                    -Dsonar.projectName=zomato \
                    -Dsonar.projectKey=zomato
                    """
                }
            }
        }

        stage('Sonar Quality Gate') {
            steps {
                waitForQualityGate abortPipeline: false, credentialsId: 'Sonar-token'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('Build App') {
            steps {
                sh 'npm run build'
            }
        }

        /* ===================== SECURITY SCANS ===================== */

        stage('OWASP Dependency Check (Docker | NON-BLOCKING)') {
            steps {
                sh '''
                docker run --rm \
                  -v "$PWD:/src" \
                  -v dependency-check-data:/usr/share/dependency-check/data \
                  owasp/dependency-check:latest \
                  --scan /src \
                  --format HTML \
                  --out /src || true
                '''
            }
        }

        stage('Trivy File Scan (Docker | NON-BLOCKING)') {
            steps {
                sh '''
                docker run --rm \
                  -v "$PWD:/project" \
                  aquasec/trivy:latest fs /project \
                  --severity HIGH,CRITICAL \
                  --exit-code 0 \
                  --no-progress > trivy.txt || true
                '''
            }
        }

        /* ===================== DOCKER ===================== */

        stage('Build Docker Image') {
            steps {
                sh 'docker build -t zomato .'
            }
        }

        stage('Tag & Push Image') {
            steps {
                withDockerRegistry(
                    credentialsId: 'docker',
                    url: 'https://index.docker.io/v1/'
                ) {
                    sh '''
                    docker tag zomato karthikn16/zomato:latest
                    docker push karthikn16/zomato:latest
                    '''
                }
            }
        }

        stage('Docker Scout Scan (NON-BLOCKING)') {
            steps {
                sh '''
                docker-scout quickview karthikn16/zomato:latest || true
                docker-scout cves karthikn16/zomato:latest || true
                docker-scout recommendations karthikn16/zomato:latest || true
                '''
            }
        }

        stage('Deploy Container') {
            steps {
                sh '''
                docker rm -f zomato || true
                docker run -d \
                  --name zomato \
                  -p 3000:3000 \
                  karthikn16/zomato:latest
                '''
            }
        }
    }

    post {
        always {
            emailext(
                subject: "Build Status: ${currentBuild.currentResult}",
                body: "Pipeline finished with status: ${currentBuild.currentResult}",
                to: "karthikeyanak16@gmail.com",
                attachmentsPattern: "trivy.txt"
            )
        }
    }
}
